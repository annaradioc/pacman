<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Успеть на Дискотеку 💃</title>
  <style>
    body {margin:0; overflow:hidden; font-family:sans-serif; background:#444; color:#fff; text-align:center;}
    #music-section,#start-section{padding:20px;}
    #game{display:none; position:relative; width:100%;max-width:500px;height:700px; margin:0 auto;background:#666;border:5px solid #fff;touch-action:manipulation;}
    .lane{position:absolute;top:0;width:2px;height:100%;background:#fff;opacity:0.5;z-index:0;}
    .player{position:absolute;bottom:80px;left:200px;width:100px;text-align:center;font-size:60px;z-index:2;transition:left .1s;}
    .obstacle,.note{position:absolute;width:100px;text-align:center;top:0;z-index:1;}
    .obstacle{font-size:60px;color:black;} .note{font-size:40px;color:yellow;}
    @keyframes fall{0%{top:-60px;}100%{top:720px;}} .falling{animation:fall linear forwards;}
    #message,#victory{position:absolute;top:50%;width:100%;text-align:center;font-size:30px;display:none;z-index:10;}
    #scoreboard{position:absolute;top:10px;left:10px;font-size:20px;z-index:10;}
    #restartBtn{display:none;position:absolute;top:70%;left:50%;transform:translateX(-50%);padding:10px 20px;font-size:18px;background:#fff;border:none;cursor:pointer;z-index:10;}
    .rave{animation:party .2s infinite alternate;} @keyframes party{0%{background:#000;}100%{background:#6600cc;}}
    #victoryEmoji{font-size:50px;margin-top:20px;display:flex;justify-content:center;flex-wrap:wrap;gap:10px;}
    .controls{display:none;position:absolute;bottom:10px;width:100%;text-align:center;z-index:5;}
    .btn{font-size:36px;padding:10px 20px;margin:5px;background:#fff;border:none;border-radius:10px;}
    @media(max-width:600px){.controls{display:block;}}
  </style>
</head>
<body>
  <!-- Этап 1: включение музыки -->
  <div id="music-section">
    <p>🎧 Чтоб не скучно было — иди 🎶</p>
    <audio id="bg-music" controls preload="none" playsinline style="width:80%;max-width:360px;"></audio><br>
    <button id="musicBtn">Включить музыку</button>
  </div>
  <!-- Этап 2: после музыки -->
  <div id="start-section" style="display:none;">
    <button id="startGameBtn">Начать игру</button>
  </div>
  <!-- Этап 3: сама игра -->
  <div id="game">
    <div class="player" id="player">🕺</div>
    <div id="message">😢 Ты не успел на дискотеку!</div>
    <div id="victory">
      🎉 Ты успел на дискотеку! 🪩<br><div id="victoryEmoji">🕺💃🎶🪩🔥🕺💃🎶</div>
    </div>
    <div id="scoreboard">Ноты: 0 | Уровень: 1</div>
    <button id="restartBtn">🔄 Играть снова</button>
    <div class="controls">
      <button class="btn" id="leftBtn">◀️</button>
      <button class="btn" id="rightBtn">▶️</button>
    </div>
  </div>

  <!-- Звуки -->
  <audio id="sfx-note" src="https://psv4.userapi.com/s/v1/amsg2/I3BC4yFr5NQ2Hl6qG-QwZfpvmcV7qUQ7QH5Qlh_7SCaCY7eUSwL7Po37yp-Dgu3VnVwAmBHBAwNtjWBsCX0_M6mhbjg.mp3"></audio>
  <audio id="sfx-fail" src="https://psv4.userapi.com/s/v1/amsg2/aiW3ku67TfH5XMDfQ87CfZ2D-ir8hINUq6vdv-JJNLkgxO8J7025imt3nwDfgVz2AEA4kRF8lYgjuh7cSNOJ-D5pKMg.mp3"></audio>
  <audio id="sfx-win" src="win.mp3" preload="auto"></audio>

<script>
  const bgMusic = document.getElementById('bg-music');
  bgMusic.src = "http://online.radioc.ru:8000/radioc"; // вставляем поток
  const musicBtn = document.getElementById('musicBtn');
  const startGameBtn = document.getElementById('startGameBtn');
  const musicSection = document.getElementById('music-section');
  const startSection = document.getElementById('start-section');
  const game = document.getElementById('game');
  // игровые элементы
  const sfxNote=document.getElementById('sfx-note'),sfxFail=document.getElementById('sfx-fail'),sfxWin=document.getElementById('sfx-win');
  const player=document.getElementById('player'), message=document.getElementById('message'), victory=document.getElementById('victory'),scoreboard=document.getElementById('scoreboard'),restartBtn=document.getElementById('restartBtn'), leftBtn=document.getElementById('leftBtn'), rightBtn=document.getElementById('rightBtn');
  const step=100, maxSteps=5, winScore=30;
  let playerX=200, gameOver=false, score=0, level=1, obstacleInterval=600, fallSpeed=2;
  let obstacleSpawner,noteSpawner, recentObstacleLanes=[];

  musicBtn.onclick = () => {
    bgMusic.play().then(()=>{
      musicBtn.disabled=true;
      musicBtn.textContent="Музыка играет 🎶";
      startSection.style.display="block";
    }).catch(()=>{
      alert("⚠️ Нажмите ▶️ внутри плеера");
    });
  };

  startGameBtn.onclick = () => {
    musicSection.style.display="none";
    startSection.style.display="none";
    game.style.display="block";
    initGame();
  };

  function initGame(){
    for(let i=1;i<maxSteps;i++){const lane=document.createElement('div');lane.className='lane';lane.style.left=`${i*step}px`;game.appendChild(lane);}  
    keyboardAndBtns();
    updateScoreboard();
    startSpawners();
  }
  function keyboardAndBtns(){
    document.addEventListener('keydown',e=>{if(gameOver)return; if(e.key==='ArrowLeft'&&playerX>0)move(-step); if(e.key==='ArrowRight'&&playerX<step*(maxSteps-1))move(step);});
    leftBtn.onclick=()=>!gameOver&&playerX>0&&move(-step);
    rightBtn.onclick=()=>!gameOver&&playerX<step*(maxSteps-1)&&move(step);
  }
  function move(d){playerX+=d; player.style.left=playerX+'px';}
  function updateScoreboard(){scoreboard.textContent=`Ноты: ${score} | Уровень: ${level}`;}
  function createObstacle(){
    if(gameOver)return;
    const obs=document.createElement('div');obs.className='obstacle falling';obs.textContent='🏠';
    const lane=Math.floor(Math.random()*maxSteps);
    obs.style.left=`${lane*step}px`;obs.style.animationDuration=`${fallSpeed}s`;
    game.appendChild(obs);recentObstacleLanes.push(lane);if(recentObstacleLanes.length>5)recentObstacleLanes.shift();
    const check=setInterval(()=>{
      const t=obs.offsetTop,l=obs.offsetLeft;
      const pt=player.offsetTop, ph=player.offsetHeight;
      const ox=Math.abs(l-playerX)<40, oy=t+50>pt&&t<pt+ph;
      if(ox&&oy){clearInterval(check);sfxFail.play();endGame(false);}
      if(t>700){clearInterval(check);obs.remove();}
    },30);
  }
  function createNote(){
    if(gameOver)return;
    let lane, attempts=0;
    do{lane=Math.floor(Math.random()*maxSteps); attempts++;}while(recentObstacleLanes.includes(lane)&&attempts<10);
    const note=document.createElement('div');note.className='note falling';note.textContent='🎵';
    note.style.left=`${lane*step}px`;note.style.animationDuration=`${fallSpeed}s`;
    game.appendChild(note);
    const check=setInterval(()=>{
      const t=note.offsetTop,l=note.offsetLeft, pt=player.offsetTop, ph=player.offsetHeight;
      const ox=Math.abs(l-playerX)<50, oy=t+40>pt&&t<pt+ph;
      if(ox&&oy){clearInterval(check);note.remove(); score++;updateScoreboard();sfxNote.currentTime=0;sfxNote.play();checkLevelUp();checkWin();}
      if(t>700){clearInterval(check);note.remove();}
    },30);
  }
  function checkLevelUp(){if(score>0&&score%10===0){level++;updateScoreboard();fallSpeed=Math.max(0.3,fallSpeed-0.2);obstacleInterval=Math.max(200,obstacleInterval-80);resetSpawners();}}
  function checkWin(){if(score>=winScore){sfxWin.play();endGame(true);}}
  function endGame(win){gameOver=true;clearInterval(obstacleSpawner);clearInterval(noteSpawner);document.querySelectorAll('.falling').forEach(el=>el.style.animationPlayState='paused');if(win){victory.style.display='block';game.classList.add('rave');}else message.style.display='block';restartBtn.style.display='block';}
  function startSpawners(){obstacleSpawner=setInterval(createObstacle,obstacleInterval);noteSpawner=setInterval(createNote,obstacleInterval*1.5);}
  function resetSpawners(){clearInterval(obstacleSpawner);clearInterval(noteSpawner);startSpawners();}
  restartBtn.onclick=()=>{
    document.querySelectorAll('.obstacle, .note').forEach(el=>el.remove());
    playerX=200;player.style.left='200px';gameOver=false;score=0;level=1;fallSpeed=2;obstacleInterval=600;recentObstacleLanes=[];
    message.style.display='none';victory.style.display='none';restartBtn.style.display='none';game.classList.remove('rave');
    updateScoreboard();startSpawners();
  };
</script>
</body>
</html>
