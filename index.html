<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–£—Å–ø–µ—Ç—å –Ω–∞ –î–∏—Å–∫–æ—Ç–µ–∫—É üíÉ</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background: #444; }
    #game {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 700px;
      margin: 0 auto;
      background: #666;
      border: 5px solid #fff;
      overflow: hidden;
      touch-action: manipulation;
    }
    .lane {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background: white;
      opacity: 0.5;
      z-index: 0;
    }
    .player {
      position: absolute;
      bottom: 80px; /* –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ */
      width: 100px;
      text-align: center;
      font-size: 60px;
      z-index: 2;
      transition: left 0.1s;
    }
    .obstacle, .note {
      position: absolute;
      width: 100px;
      text-align: center;
      top: 0;
      font-size: 60px;
      z-index: 1;
    }
    .note { font-size: 40px; color: yellow; }
    .obstacle { color: black; }
    @keyframes fall { 0% { top: -60px; } 100% { top: 720px; } }
    .falling { animation: fall linear forwards; }
    #message, #victory {
      position: absolute;
      top: 50%;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 30px;
      display: none;
      z-index: 10;
    }
    #scoreboard {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      font-size: 20px;
      z-index: 10;
    }
    #restartBtn {
      display: none;
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 18px;
      background: #fff;
      border: none;
      cursor: pointer;
      z-index: 10;
    }
    .controls {
      display: none;
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      z-index: 5;
    }
    .btn {
      font-size: 36px;
      padding: 10px 20px;
      margin: 5px;
      background: #fff;
      border: none;
      border-radius: 10px;
    }
    @media (max-width: 600px) {
      .controls { display: block; }
    }
  </style>
</head>
<body>
  <div id="game">
    <div class="player" id="player">üï∫</div>
    <div id="scoreboard">–ù–æ—Ç—ã: 0 | –£—Ä–æ–≤–µ–Ω—å: 1</div>
    <div id="message">üò¢ –¢—ã –Ω–µ —É—Å–ø–µ–ª –Ω–∞ –¥–∏—Å–∫–æ—Ç–µ–∫—É!</div>
    <div id="victory">üéâ –¢—ã —É—Å–ø–µ–ª –Ω–∞ –¥–∏—Å–∫–æ—Ç–µ–∫—É! ü™©<div id="victoryEmoji">üï∫üíÉüé∂ü™©üî•</div></div>
    <button id="restartBtn">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    <div class="controls">
      <button class="btn" id="leftBtn">‚óÄÔ∏è</button>
      <button class="btn" id="rightBtn">‚ñ∂Ô∏è</button>
    </div>
  </div>

  <audio id="sfx-note" src="note.mp3" preload="auto"></audio>
  <audio id="sfx-fail" src="fail.mp3" preload="auto"></audio>
  <audio id="sfx-win" src="win.mp3" preload="auto"></audio>

  <script>
    const sfxNote = document.getElementById('sfx-note');
    const sfxFail = document.getElementById('sfx-fail');
    const sfxWin = document.getElementById('sfx-win');
    const game = document.getElementById('game');
    const player = document.getElementById('player');
    const message = document.getElementById('message');
    const victory = document.getElementById('victory');
    const scoreboard = document.getElementById('scoreboard');
    const restartBtn = document.getElementById('restartBtn');
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');

    let maxSteps = window.innerWidth < 600 ? 4 : 5;
    const gameWidth = game.offsetWidth || 500;
    const step = Math.floor(gameWidth / maxSteps);
    let playerX = Math.floor((maxSteps - 1) / 2) * step;
    let score = 0, level = 1, gameOver = false;
    let obstacleInterval = 600, fallSpeed = 2;
    let obstacleSpawner, noteSpawner;
    let recentObstacleLanes = [];

    player.style.left = playerX + 'px';

    // —Å–æ–∑–¥–∞—ë–º –ø–æ–ª–æ—Å—ã
    for (let i = 1; i < maxSteps; i++) {
      const lane = document.createElement('div');
      lane.className = 'lane';
      lane.style.left = `${i * step}px`;
      game.appendChild(lane);
    }

    document.addEventListener('keydown', e => {
      if (gameOver) return;
      if (e.key === 'ArrowLeft' && playerX > 0) movePlayer(-step);
      if (e.key === 'ArrowRight' && playerX < (step * (maxSteps - 1))) movePlayer(step);
    });
    leftBtn.onclick = () => { if (!gameOver && playerX > 0) movePlayer(-step); };
    rightBtn.onclick = () => { if (!gameOver && playerX < (step * (maxSteps - 1))) movePlayer(step); };

    function movePlayer(delta) {
      playerX = Math.max(0, Math.min((maxSteps - 1) * step, playerX + delta));
      player.style.left = playerX + 'px';
    }

    function updateScoreboard() {
      scoreboard.textContent = `–ù–æ—Ç—ã: ${score} | –£—Ä–æ–≤–µ–Ω—å: ${level}`;
    }

    function createObstacle() {
      if (gameOver) return;
      const obs = document.createElement('div');
      obs.classList.add('obstacle', 'falling');
      obs.textContent = 'üè†';
      const lane = Math.floor(Math.random() * maxSteps);
      obs.style.left = `${lane * step}px`;
      obs.style.animationDuration = `${fallSpeed}s`;
      game.appendChild(obs);
      recentObstacleLanes.push(lane);
      if (recentObstacleLanes.length > 5) recentObstacleLanes.shift();
      const check = setInterval(() => {
        const top = obs.offsetTop, left = obs.offsetLeft;
        if (top > 600 && Math.abs(left - playerX) < step * 0.3) {
          clearInterval(check); sfxFail.currentTime = 0; sfxFail.play(); endGame(false);
        }
        if (top > 700) { clearInterval(check); obs.remove(); }
      }, 50);
    }

    function createNote() {
      if (gameOver) return;
      let lane, attempts = 0;
      do {
        lane = Math.floor(Math.random() * maxSteps);
        attempts++;
      } while (recentObstacleLanes.includes(lane) && attempts < 10);
      const note = document.createElement('div');
      note.classList.add('note', 'falling');
      note.textContent = 'üéµ';
      note.style.left = `${lane * step}px`;
      note.style.animationDuration = `${fallSpeed}s`;
      game.appendChild(note);
      const check = setInterval(() => {
        const top = note.offsetTop, left = note.offsetLeft;
        if (Math.abs(left - playerX) < step * 1.2) {
          clearInterval(check); note.remove();
          score++; updateScoreboard();
          sfxNote.currentTime = 0; sfxNote.play();
          checkLevelUp(); checkWin();
        }
        if (top > 700) clearInterval(check) && note.remove();
      }, 50);
    }

    function checkLevelUp() {
      if (score > 0 && score % 10 === 0) {
        level++; updateScoreboard();
        fallSpeed = Math.max(0.3, fallSpeed - 0.2);
        obstacleInterval = Math.max(200, obstacleInterval - 80);
        clearInterval(obstacleSpawner); clearInterval(noteSpawner);
        obstacleSpawner = setInterval(createObstacle, obstacleInterval);
        noteSpawner = setInterval(createNote, obstacleInterval * 1.5);
      }
    }

    function checkWin() {
      if (score >= 30) {
        sfxWin.currentTime = 0; sfxWin.play();
        endGame(true);
      }
    }

    function endGame(win) {
      gameOver = true;
      clearInterval(obstacleSpawner); clearInterval(noteSpawner);
      document.querySelectorAll('.falling').forEach(el => el.style.animationPlayState = 'paused');
      if (win) victory.style.display = 'block'; else message.style.display = 'block';
      restartBtn.style.display = 'block';
    }

    restartBtn.onclick = () => {
      location.reload();
    };

    updateScoreboard();
    obstacleSpawner = setInterval(createObstacle, obstacleInterval);
    noteSpawner = setInterval(createNote, obstacleInterval * 1.5);
  </script>
</body>
</html>
